{"title":"5)📱iOS앱개발 - Lambda 함수 생성 & API 배포하기","uid":"3dd5dd23bc1bf752e32b431e49dca7c1","slug":"Assemble/220112_05/2022-01-12-assemble05","date":"2022-01-11T15:00:00.000Z","updated":"2023-03-31T10:38:04.381Z","comments":true,"path":"api/articles/Assemble/220112_05/2022-01-12-assemble05.json","keywords":null,"cover":[],"content":"<h3 id=\"함수를-테스트할-로컬-환경-만들기\"><a href=\"#함수를-테스트할-로컬-환경-만들기\" class=\"headerlink\" title=\"함수를 테스트할 로컬 환경 만들기\"></a>함수를 테스트할 로컬 환경 만들기</h3><p>완성된 함수를 아마존 서버에 올리고 싶어서 로컬에서 먼저 테스트하기 위한 환경을 만들어주겠습니다. 파이썬을 사용해서 MySQL에 접근해야하기 때문에 먼저 PyMySQL이라는 라이브러리를 설치해야 합니다. 아래 명령어로 설치해줍니다. (맥 환경)</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">$ pip install PyMySQL<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>이제 테스트 코드를 작성해보겠습니다.</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">import pymysql as mysql\nimport pandas as pd\n\ndb &#x3D; mysql.connect(\n    host&#x3D;&#39;본인의 RDS 엔드포인트&#39;, \n    user&#x3D;&#39;RDS username&#39;, \n    password&#x3D;&#39;RDS password&#39;, \n    db&#x3D;&#39;본인의 DB 이름&#39;, \n    charset&#x3D;&#39;utf8&#39;\n)\n\ntry:\n    with db.cursor(mysql.cursors.DictCursor) as cursor:\n        sql &#x3D; &quot;SELECT * FROM actor&quot;\n        cursor.execute(sql)\n        result &#x3D; cursor.fetchall()\n\n        result &#x3D; pd.DataFrame(result)\n        print(result)\nfinally:\n    db.close()<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"DB-연결-connect\"><a href=\"#DB-연결-connect\" class=\"headerlink\" title=\"DB 연결 - connect()\"></a>DB 연결 - connect()</h4><pre class=\"line-numbers language-none\"><code class=\"language-none\">db &#x3D; mysql.connect(\n    host&#x3D;&#39;본인의 RDS 엔드포인트&#39;, \n    user&#x3D;&#39;RDS username&#39;, \n    password&#x3D;&#39;RDS password&#39;, \n    db&#x3D;&#39;본인의 DB 이름&#39;, \n    charset&#x3D;&#39;utf8&#39;\n)<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>connect() 함수를 통해 RDS의 DB에 직접적으로 연결할 수 있습니다. </p>\n<ul>\n<li>host: RDS 엔드포인트</li>\n<li>user: 설정한 RDS username</li>\n<li>password: 설정한 RDS password</li>\n<li>db: RDS DB 이름</li>\n<li>charset: 문자 인코더</li>\n</ul>\n<h4 id=\"커서-사용-cursor\"><a href=\"#커서-사용-cursor\" class=\"headerlink\" title=\"커서 사용 - cursor()\"></a>커서 사용 - cursor()</h4><pre class=\"line-numbers language-none\"><code class=\"language-none\">db.cursor(mysql.cursors.DictCursor) as cursor<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p>PyMySQL에서는 커서를 사용해 DB에 접근할 수 있습니다. 파이썬 작업 중에도 가시성이 좋은 출력 결과를 얻고 싶어 데이터프레임 형태로 출력하기로 했습니다. 이를 위해 Dictionary 형태로 결과를 내보내는 <strong>DictCursor</strong>를  사용하였습니다.</p>\n<h4 id=\"데이터-접근-execute\"><a href=\"#데이터-접근-execute\" class=\"headerlink\" title=\"데이터 접근 - execute()\"></a>데이터 접근 - execute()</h4><pre class=\"line-numbers language-none\"><code class=\"language-none\">sql &#x3D; &quot;SELECT * FROM actor&quot;\ncursor.execute(sql)\nresult &#x3D; cursor.fetchall()<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p><strong>execute()</strong> 함수의 파라미터로 쿼리문을 넣어 SQL을 실행하고 <strong>fetch 함수</strong>를 사용해 결과를 받아올 수 있습니다. fetch 함수에도 여러 종류가 있는데 다음과 같습니다.</p>\n<ul>\n<li><strong>fetchall()</strong>: 모든 데이터를 한 번에 fetch</li>\n<li><strong>fetchone()</strong>: 하나의 행만 fetch</li>\n<li><strong>fetchmany(n)</strong>: n개의 데이터를 fetch</li>\n</ul>\n<h4 id=\"결과를-데이터프레임으로-출력\"><a href=\"#결과를-데이터프레임으로-출력\" class=\"headerlink\" title=\"결과를 데이터프레임으로 출력\"></a>결과를 데이터프레임으로 출력</h4><pre class=\"line-numbers language-none\"><code class=\"language-none\">result &#x3D; pd.DataFrame(result)\nprint(result)<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n<p><strong>pandas</strong> 라이브러리를 사용해 결과를 데이터프레임의 형태로 출력해줍니다.</p>\n<h4 id=\"데이터-적용-commit\"><a href=\"#데이터-적용-commit\" class=\"headerlink\" title=\"데이터 적용 - commit()\"></a>데이터 적용 - commit()</h4><p><strong>INSERT, UPDATE, DELETE</strong>문은 DB에 변경이 생기게 되므로 <strong>commit</strong> 과정이 필요합니다. 저의 예시에서는 SELECT만 사용하여 commit을 하지 않았지만 이 외의 경우에는 매우 중요합니다.</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">db.commit()<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h5 id=\"결과\"><a href=\"#결과\" class=\"headerlink\" title=\"결과\"></a>결과</h5><img src=\"https://github.com/StanSign/StanSign.github.io/blob/main/_posts/Assemble/220112_05/cap01.png?raw=true\" alt=\"Result\" width=\"400\">\n\n<h4 id=\"Placeholder\"><a href=\"#Placeholder\" class=\"headerlink\" title=\"Placeholder\"></a>Placeholder</h4><p>sql문을 작성할 때 <strong>placeholder</strong>를 사용해 데이터를 동적으로 다룰 수 있습니다.</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">data &#x3D; (&#39;케빈 파이기&#39;, 500000000)\n# data &#x3D; [[&#39;케빈 파이기&#39;, 1536253195], [&#39;에이미 파스칼&#39;, 1536253195], [&#39;제임스 건&#39;, 167400219]]\n\nsql &#x3D; &quot;SELECT * FROM filmInfo WHERE fDirector &#x3D; %s AND fBoxOffice &gt; %s&quot;\nexecute(sql, data)\nexecutemany(sql, multiple data)<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>두 번째 파라미터에 들어간 data들이 작성된 순서대로 실행되어 반복문과 같은 동작을 하게 됩니다. </p>\n<h3 id=\"Lambda에-함수-적용하기\"><a href=\"#Lambda에-함수-적용하기\" class=\"headerlink\" title=\"Lambda에 함수 적용하기\"></a>Lambda에 함수 적용하기</h3><p>이제 AWS 서버에 전의 과정을 통해 만들어진 함수들을 업로드해보겠습니다. 우선 이 함수에서 사용된 라이브러리들이 서버에는 없기 때문에 우리가 직접 제공해줘야 합니다. 아래 명령어를 통해 라이브러리를 원하는 디렉토리에 다운로드 받습니다.</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">$ pip install PyMySQL -t .<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>그리고 위의 함수에서 DB의 정보에 대한 부분을 dbinfo.py 파일에 따로 분리해주겠습니다.</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">db_host&#x3D;&#39;본인의 RDS 엔드포인트&#39;\ndb_user&#x3D;&#39;RDS username&#39;\ndb_password&#x3D;&#39;RDS password&#39;\ndb_name&#x3D;&#39;본인의 DB 이름&#39;\ndb_charset&#x3D;&#39;utf8&#39;\ndb_port&#x3D;3306 # RDS default<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>원래 함수의 DB 정보 부분도 수정해줍니다.</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">import dbinfo\n\ndb &#x3D; mysql.connect(\n    host&#x3D;dbinfo.db_host, \n    user&#x3D;dbinfo.db_user, \n    password&#x3D;dbinfo.db_password, \n    db&#x3D;dbinfo.db_name, \n    charset&#x3D;dbinfo.db_charset\n)<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>마지막으로 테스트를 위해 사용했던 pandas 라이브러리를 사용하지 않게 바꾸어줍니다.</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">result &#x3D; pd.DataFrame(result)\nprint(result)<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">for result in results:\n    print(result)<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n<p>위 코드를 아래 코드와 같이 바꿔주고, pandas를 import한 부분도 삭제해줍니다.<br><img src=\"https://github.com/StanSign/StanSign.github.io/blob/main/_posts/Assemble/220112_05/cap02.png?raw=true\" alt=\"zip\" width=\"550\"><br>최종적으로 얻은 이 네가지 파일과 폴더를 zip파일로 압축해줍니다. 이 압축 파일을 lambda 함수에 업로드 해야합니다.<br><img src=\"https://github.com/StanSign/StanSign.github.io/blob/main/_posts/Assemble/220112_05/cap03.png?raw=true\" alt=\"upload zip\" width=\"300\"><br>우측 상단에서 업로드를 진행하면,<br><img src=\"https://github.com/StanSign/StanSign.github.io/blob/main/_posts/Assemble/220112_05/cap04.png?raw=true\" alt=\"result\" width=\"550\"><br>이렇게 lambda 함수의 내용이 압축 파일의 내용으로 교체됩니다.<br><img src=\"https://github.com/StanSign/StanSign.github.io/blob/main/_posts/Assemble/220112_05/cap05.png?raw=true\" alt=\"runtime\" width=\"550\"><br><img src=\"https://github.com/StanSign/StanSign.github.io/blob/main/_posts/Assemble/220112_05/cap06.png?raw=true\" alt=\"runtime2\" width=\"550\"><br>마지막으로 코드 하단에 있는 <strong>런타임 설정 &gt; 편집</strong>에서 핸들러를 <strong>실행할 파일 이름.그 코드에서 실행할 함수 이름</strong>으로 바꿔주고 저장합니다.<br><img src=\"https://github.com/StanSign/StanSign.github.io/blob/main/_posts/Assemble/220112_05/cap07.png?raw=true\" alt=\"test\" width=\"550\"><br>이제 이 코드를 Test 해보겠습니다. Test 버튼을 누르고,<br><img src=\"https://github.com/StanSign/StanSign.github.io/blob/main/_posts/Assemble/220112_05/cap08.png?raw=true\" alt=\"test2\" width=\"550\"><br>이벤트 이름을 정해주고, 제 코드는 파라미터가 필요없으므로 공란으로 두고 생성해줍니다. 다음부터는 이벤트 템플릿에 저장된 테스트 이벤트를 선택해서 사용해줄 수 있습니다.<br><img src=\"https://github.com/StanSign/StanSign.github.io/blob/main/_posts/Assemble/220112_05/cap09.png?raw=true\" alt=\"result\" width=\"550\"><br>이렇게 결과가 정상적으로 출력되었다면 성공입니다!</p>\n<h3 id=\"API-배포\"><a href=\"#API-배포\" class=\"headerlink\" title=\"API 배포\"></a>API 배포</h3><p>이렇게 만들어진 API를 배포해보겠습니다. API Gateway로 돌아와서 API 배포를 해줍니다.<br><img src=\"https://github.com/StanSign/StanSign.github.io/blob/main/_posts/Assemble/220112_05/cap10.png?raw=true\" alt=\"Deploy\" width=\"550\"><br><img src=\"https://github.com/StanSign/StanSign.github.io/blob/main/_posts/Assemble/220112_05/cap11.png?raw=true\" alt=\"Deploy\" width=\"550\"></p>\n<p>스테이지 편집기의 상단에 API 호출 주소가 표시됩니다.<br><img src=\"https://github.com/StanSign/StanSign.github.io/blob/main/_posts/Assemble/220112_05/cap12.png?raw=true\" alt=\"Result\" width=\"550\"></p>\n<p>왼쪽에서 이전에 만든 주소를 찾아 들어가면 해당 주소의 API 호출 주소도 볼 수 있습니다.<br><img src=\"https://github.com/StanSign/StanSign.github.io/blob/main/_posts/Assemble/220112_05/cap13.png?raw=true\" alt=\"GET\" width=\"550\"></p>\n<p>이 주소로 접속해보면 현재는 null이 뜨는 것이 정상입니다. Lambda 함수에서 아무것도 return 해주지 않았기 때문이죠. API 주소가 제대로 작동하는 것을 확인했으니 이제 정말로 return 값도 만들어줍시다. Lambda 서비스로 돌아가 코드를 수정해줍니다. 저는 list를 만들어 결과들을 append 해준 뒤 return 해주었습니다.</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">import dbinfo\nimport pymysql as mysql\n\ndb &#x3D; mysql.connect(\n    host&#x3D;dbinfo.db_host, \n    user&#x3D;dbinfo.db_user, \n    password&#x3D;dbinfo.db_password, \n    db&#x3D;dbinfo.db_name, \n    charset&#x3D;dbinfo.db_charset)\n\ndef lambda_handler(event, context):\n    result_list &#x3D; []\n    try:\n        with db.cursor(mysql.cursors.DictCursor) as cursor:\n            sql &#x3D; &quot;SELECT * FROM actor&quot;\n            cursor.execute(sql)\n            results &#x3D; cursor.fetchall()\n    \n            for result in results:\n                print(result)\n                result_list.append(result)\n    finally:\n        return result_list<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>이제 다시 API 호출 주소로 접속해보면?<br><img src=\"https://github.com/StanSign/StanSign.github.io/blob/main/_posts/Assemble/220112_05/cap14.png?raw=true\" alt=\"API result\" width=\"300\"></p>\n<p>이렇게 결과값이 나오면 API 생성에 성공한 것입니다!</p>\n","text":"함수를 테스트할 로컬 환경 만들기완성된 함수를 아마존 서버에 올리고 싶어서 로컬에서 먼저 테스트하기 위한 환경을 만들어주겠습니다. 파이썬을 사용해서 MySQL에 접근해야하기 때문에 먼저 PyMySQL이라는 라이브러리를 설치해야 합니다. 아래 명령어로 ...","link":"","photos":[],"count_time":{"symbolsCount":"4.6k","symbolsTime":"4 mins."},"categories":[{"name":"Assemble","slug":"Assemble","count":9,"path":"api/categories/Assemble.json"}],"tags":[{"name":"Python","slug":"Python","count":6,"path":"api/tags/Python.json"},{"name":"AWS","slug":"AWS","count":5,"path":"api/tags/AWS.json"},{"name":"mySQL","slug":"mySQL","count":4,"path":"api/tags/mySQL.json"},{"name":"Assemble","slug":"Assemble","count":9,"path":"api/tags/Assemble.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%ED%95%A8%EC%88%98%EB%A5%BC-%ED%85%8C%EC%8A%A4%ED%8A%B8%ED%95%A0-%EB%A1%9C%EC%BB%AC-%ED%99%98%EA%B2%BD-%EB%A7%8C%EB%93%A4%EA%B8%B0\"><span class=\"toc-text\">함수를 테스트할 로컬 환경 만들기</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#DB-%EC%97%B0%EA%B2%B0-connect\"><span class=\"toc-text\">DB 연결 - connect()</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%EC%BB%A4%EC%84%9C-%EC%82%AC%EC%9A%A9-cursor\"><span class=\"toc-text\">커서 사용 - cursor()</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%EB%8D%B0%EC%9D%B4%ED%84%B0-%EC%A0%91%EA%B7%BC-execute\"><span class=\"toc-text\">데이터 접근 - execute()</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%EA%B2%B0%EA%B3%BC%EB%A5%BC-%EB%8D%B0%EC%9D%B4%ED%84%B0%ED%94%84%EB%A0%88%EC%9E%84%EC%9C%BC%EB%A1%9C-%EC%B6%9C%EB%A0%A5\"><span class=\"toc-text\">결과를 데이터프레임으로 출력</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%EB%8D%B0%EC%9D%B4%ED%84%B0-%EC%A0%81%EC%9A%A9-commit\"><span class=\"toc-text\">데이터 적용 - commit()</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-5\"><a class=\"toc-link\" href=\"#%EA%B2%B0%EA%B3%BC\"><span class=\"toc-text\">결과</span></a></li></ol></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#Placeholder\"><span class=\"toc-text\">Placeholder</span></a></li></ol></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#Lambda%EC%97%90-%ED%95%A8%EC%88%98-%EC%A0%81%EC%9A%A9%ED%95%98%EA%B8%B0\"><span class=\"toc-text\">Lambda에 함수 적용하기</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#API-%EB%B0%B0%ED%8F%AC\"><span class=\"toc-text\">API 배포</span></a></li></ol>","author":{"name":"nomatterjun","slug":"blog-author","avatar":"https://avatars.githubusercontent.com/u/60438045?v=4","link":"/","description":"안녕하세요 👋 <br/> 바쁜 현대인들의 일상에 <br/> 작은 변화를 심고 싶은 개발자 <br/> 이창준입니다.","socials":{"github":"https://github.com/nomatterjun","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{"instagram":{"icon":"fab fa-instagram","link":"https://www.instagram.com/nomatter_jun/"}}}},"mapped":true,"prev_post":{"title":"6)📱iOS앱개발 - DB 재설계","uid":"291cbcf6b4765cf7164ff2800622aa73","slug":"Assemble/220124_06/2022-01-24-assemble06","date":"2022-01-23T15:00:00.000Z","updated":"2023-03-31T10:38:18.055Z","comments":true,"path":"api/articles/Assemble/220124_06/2022-01-24-assemble06.json","keywords":null,"cover":[],"text":"DB 재설계이전의 DB는 관계형DB로서의 기능을 하지 못하였습니다. 각 인스턴스 사이의 관계를 설명할 수 없었고, 자연스럽게 외래키도 잘못 연결되어 있었습니다. 그래서 다음과 같이 처음부터 다시 뜯어고쳤습니다. film과 filmInfo 테이블이 분리...","link":"","photos":[],"count_time":{"symbolsCount":"2.6k","symbolsTime":"2 mins."},"categories":[{"name":"Assemble","slug":"Assemble","count":9,"path":"api/categories/Assemble.json"}],"tags":[{"name":"mySQL","slug":"mySQL","count":4,"path":"api/tags/mySQL.json"},{"name":"Assemble","slug":"Assemble","count":9,"path":"api/tags/Assemble.json"}],"author":{"name":"nomatterjun","slug":"blog-author","avatar":"https://avatars.githubusercontent.com/u/60438045?v=4","link":"/","description":"안녕하세요 👋 <br/> 바쁜 현대인들의 일상에 <br/> 작은 변화를 심고 싶은 개발자 <br/> 이창준입니다.","socials":{"github":"https://github.com/nomatterjun","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{"instagram":{"icon":"fab fa-instagram","link":"https://www.instagram.com/nomatter_jun/"}}}}},"next_post":{"title":"4)📱iOS앱개발 - API Gateway, Lambda 사용하기","uid":"6fb7b20ef7439001e04bd4ee42c09224","slug":"Assemble/220111_04/2022-01-11-assemble04","date":"2022-01-10T15:00:00.000Z","updated":"2023-03-31T10:37:48.506Z","comments":true,"path":"api/articles/Assemble/220111_04/2022-01-11-assemble04.json","keywords":null,"cover":[],"text":"사용할 AWS 서비스들우선.. 안그래도 처음 다뤄보는 AWS인데 사용하는 서비스들이 너무 많게 느껴집니다.. 하지만 모바일 어플리케이션에서는 API의 형태로 DB에 접근하는 것이 좋다고 해서 이런 방식으로 진행해보고자 합니다. 진행 과정에서 많은 오류...","link":"","photos":[],"count_time":{"symbolsCount":"1.6k","symbolsTime":"1 mins."},"categories":[{"name":"Assemble","slug":"Assemble","count":9,"path":"api/categories/Assemble.json"}],"tags":[{"name":"AWS","slug":"AWS","count":5,"path":"api/tags/AWS.json"},{"name":"Assemble","slug":"Assemble","count":9,"path":"api/tags/Assemble.json"}],"author":{"name":"nomatterjun","slug":"blog-author","avatar":"https://avatars.githubusercontent.com/u/60438045?v=4","link":"/","description":"안녕하세요 👋 <br/> 바쁜 현대인들의 일상에 <br/> 작은 변화를 심고 싶은 개발자 <br/> 이창준입니다.","socials":{"github":"https://github.com/nomatterjun","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{"instagram":{"icon":"fab fa-instagram","link":"https://www.instagram.com/nomatter_jun/"}}}}}}